if _G.VAR_TIME_TRIAL then
	warn("â›” Script Ä‘Ã£ Ä‘Æ°á»£c cháº¡y trÆ°á»›c Ä‘Ã³!")
	return
end

_G.VAR_TIME_TRIAL = true
_G.STOP_TIME_TRIAL = false

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local Save = require(ReplicatedStorage.Library.Client.Save)
local ZoneCmds = require(ReplicatedStorage.Library.Client.ZoneCmds)

local lagFlag = false
local endFlag = false
local lagMonitorThread, increaseMonitorThread, monitor12minThread

-- ğŸ›¡ï¸ Láº¥y HumanoidRootPart an toÃ n
local function getHumanoidRootPart()
	local character = player.Character or player.CharacterAdded:Wait()
	if not character then return nil end

	local hrp = character:FindFirstChild("HumanoidRootPart")
	local waitTime = 0
	while not hrp and waitTime < 5 do
		task.wait(0.5)
		waitTime += 0.5
		hrp = character:FindFirstChild("HumanoidRootPart")
	end

	return hrp
end

-- ğŸ“Š HÃ m tiá»‡n Ã­ch

-- HÃ m helper láº¥y data an toÃ n, retry tá»‘i Ä‘a 3 láº§n rá»“i tráº£ vá» máº·c Ä‘á»‹nh
local function safeFetchSave()
    for i = 1, 3 do
        local ok, data = pcall(Save.Get)
        if ok and data and data.TimeTrialStats then
            return data.TimeTrialStats
        end
        task.wait(1)
    end
    -- Náº¿u 3 láº§n váº«n khÃ´ng há»£p lá»‡, tráº£ vá» giÃ¡ trá»‹ máº·c Ä‘á»‹nh
    return {
        DailyRuns = 0,
        Points    = 0,
        TotalRuns = 0,
    }
end

-- -> DÃ¹ng láº¡i cho táº¥t cáº£
local function getRunsUsed()
    local stats = safeFetchSave()
    return stats.DailyRuns or 0
end

local function getRunsLeft()
    return 10 - getRunsUsed()
end

local function getTimeTrialPoints()
    local stats = safeFetchSave()
    return stats.Points or 0
end

local function getTotalRuns()
    local stats = safeFetchSave()
    return stats.TotalRuns or 0
end

-- ğŸ—ºï¸ Teleport há»— trá»£
local function teleportTo(part)
	local hrp = getHumanoidRootPart()
	if hrp and part and part.CFrame then
		hrp.CFrame = part.CFrame + Vector3.new(0, 5, 0)
	end
end

local function teleportToRewardLocation()
	warn("ğŸš¶â€â™‚ï¸ Äang teleport Ä‘áº¿n vá»‹ trÃ­ Ä‘á»•i quÃ ...")
	local hrp = getHumanoidRootPart()
	if hrp then
		hrp.CFrame = CFrame.new(-14221, 17.39, 2210)
	end
end

local function teleportToLocation()
	warn("ğŸš¶â€â™‚ï¸ Äang teleport vá» vá»‹ trÃ­ map 269...")
	local hrp = getHumanoidRootPart()
	if hrp then
		hrp.CFrame = CFrame.new(-14251, 17.39, 2154)
	end
end

local function safeTeleportOut()
	teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Leave)
	task.wait(9)
	if increaseMonitorThread then pcall(task.cancel, increaseMonitorThread) increaseMonitorThread = nil end
	if lagMonitorThread then pcall(task.cancel, lagMonitorThread) lagMonitorThread = nil end
end

-- ğŸ” Láº¥y Max Zone tá»« Map4
local function getMaxZoneFromMap4()
	local mapFolder = workspace:FindFirstChild("Map4")
	if not mapFolder then return 0 end

	local maxZone = 0
	for _, folder in ipairs(mapFolder:GetChildren()) do
		if folder:IsA("Folder") then
			local zoneNumber = tonumber(folder.Name:match("^(%d+)"))
			if zoneNumber and zoneNumber > maxZone then
				maxZone = zoneNumber
			end
		end
	end
	return maxZone
end

-- ğŸ• Chá» Ä‘áº¿n khi Ä‘áº¡t Max Zone
local function waitUntilReachMaxZone(useCustomZone)
	local maxMapZone = useCustomZone and 274 or getMaxZoneFromMap4()

	while true do
		local success, data = pcall(function()
			local _, zoneData = ZoneCmds.GetMaxOwnedZone()
			return zoneData
		end)

		local current = success and data and data.ZoneNumber or 0

		if current >= maxMapZone then
			warn("âœ… ÄÃ£ Ä‘áº¡t Zone tá»‘i Ä‘a (" .. tostring(current) .. ")")
			break
		else
			warn("â³ ChÆ°a Ä‘áº¡t Zone tá»‘i Ä‘a (" .. tostring(current) .. "/" .. tostring(maxMapZone) .. "), Ä‘á»£i 60s...")
			task.wait(60)
		end
	end
end

-- ğŸ§ª Gá»i hÃ m vá»›i tÃ¹y chá»n
waitUntilReachMaxZone(true)  -- DÃ¹ng zone cá»‘ Ä‘á»‹nh 274
--waitUntilReachMaxZone(false) -- DÃ¹ng zone láº¥y tá»« Map4

-- â±ï¸ Monitor 12 phÃºt khÃ´ng tÄƒng lÆ°á»£t/TotalRuns trá»±c tiáº¿p
local function startMonitor12Min()
    monitor12minThread = task.spawn(function()
        -- Khá»Ÿi táº¡o giÃ¡ trá»‹ Ä‘áº§u
        local lastUsed      = getRunsUsed()          -- sá»‘ lÆ°á»£t Ä‘Ã£ dÃ¹ng
        local lastPoints    = getTimeTrialPoints()   -- Ä‘iá»ƒm hiá»‡n táº¡i
        local timer         = 0
        local teleportCount = 0  -- Ä‘áº¿m sá»‘ láº§n teleport out mÃ  khÃ´ng Ä‘á»•i lÆ°á»£t

        while true do
            -- Náº¿u Ä‘Ã£ Ä‘á»§ 10 lÆ°á»£t thÃ¬ dá»«ng háº³n
            if getRunsUsed() >= 10 then
                warn("ğŸ›‘ ÄÃ£ Ä‘á»§ 10 lÆ°á»£t â†’ dá»«ng theo dÃµi 12 phÃºt.")
                return
            end

            task.wait(10)
            timer = timer + 10

            -- Láº¥y giÃ¡ trá»‹ hiá»‡n táº¡i
            local curUsed   = getRunsUsed()
            local curPoints = getTimeTrialPoints()

            -- Kiá»ƒm tra Ä‘iá»u kiá»‡n reset hoáº·c teleport out
            local runChanged    = (curUsed ~= lastUsed or curPoints ~= lastPoints)
            local teleportEvent = (endFlag or lagFlag)

            if runChanged or teleportEvent then
                -- Náº¿u chá»‰ teleport out mÃ  khÃ´ng Ä‘á»•i lÆ°á»£t/Ä‘iá»ƒm, tÄƒng bá»™ Ä‘áº¿m
                if teleportEvent and not runChanged then
                    teleportCount = teleportCount + 1
                    warn("âš ï¸ Teleport out mÃ  khÃ´ng Ä‘á»•i lÆ°á»£t/Ä‘iá»ƒm láº§n " .. teleportCount)
                    if teleportCount > 7 then
                        player:Kick("â° QuÃ¡ 7 láº§n teleport out mÃ  khÃ´ng Ä‘á»•i lÆ°á»£t â†’ nghi ngá» treo mÃ¡y.")
                        return
                    end
                end

                -- Náº¿u cÃ³ runChanged thÃ¬ reset bá»™ Ä‘áº¿m teleport
                if runChanged then
                    teleportCount = 0
                end

                -- Cáº­p nháº­t láº¡i má»‘c, reset bá»™ Ä‘áº¿m thá»i gian vÃ  flags
                lastUsed   = curUsed
                lastPoints = curPoints
                timer      = 0
                endFlag    = false
                lagFlag    = false

                warn("ğŸ”„ Reset monitor12min do cÃ³ hoáº¡t Ä‘á»™ng trong Time Trial.")
            end

            -- Náº¿u vÆ°á»£t quÃ¡ 720 giÃ¢y (12 phÃºt) mÃ  khÃ´ng reset thÃ¬ kick
            if timer >= 720 then
                player:Kick("â° 12 phÃºt khÃ´ng Ä‘á»•i lÆ°á»£t hoáº·c Ä‘iá»ƒm â†’ nghi ngá» treo mÃ¡y.")
                return
            end
        end
    end)
end

-- ğŸ“Œ Theo dÃµi Ä‘á»©ng yÃªn
local function startLagMonitor()
    lagMonitorThread = task.spawn(function()
        local retryCount = 0

        while true do
            -- Láº¥y HRP an toÃ n
            local hrp = getHumanoidRootPart()
            if not hrp then
                task.wait(5)
                continue
            end

            -- Ghi nháº­n vá»‹ trÃ­, Ä‘á»£i 60s
            local lastPos = hrp.Position
            task.wait(60)
            local currPos = hrp.Position

            -- Náº¿u Ä‘á»©ng im (khoáº£ng cÃ¡ch <1) thÃ¬ tÄƒng Ä‘áº¿m
            if (lastPos - currPos).Magnitude < 1 then
                retryCount += 1
                warn("âš ï¸ Äá»©ng im " .. retryCount .. " láº§n")

                if retryCount > 3 then
                    -- Äá»©ng im láº§n thá»© 4 trá»Ÿ Ä‘i â†’ kick
                    player:Kick("Lag quÃ¡ lÃ¢u trong Time Trial.")
                    return
                else
                    -- Äá»©ng im â‰¤3 láº§n â†’ tele out 1 láº§n rá»“i dá»«ng monitor
                    lagFlag = true
                    safeTeleportOut()
                    return
                end
            else
                -- Náº¿u di chuyá»ƒn, reset láº¡i bá»™ Ä‘áº¿m
                retryCount = 0
            end

            -- Nhá» delay trÆ°á»›c láº§n check tiáº¿p theo
            task.wait(5)
        end
    end)
end

-- ğŸ§  Theo dÃµi tÄƒng Ä‘iá»ƒm
local function startIncreaseMonitor(startPoints, startRuns)
    increaseMonitorThread = task.spawn(function()
        warn("â³ Theo dÃµi tÄƒng Äiá»ƒm/TotalRuns")
        while true do
            -- Náº¿u lagFlag báº­t, thÃ´i dá»«ng monitor
            if lagFlag then return end

            -- Khi phÃ¡t hiá»‡n Ä‘iá»ƒm hoáº·c TotalRuns tÄƒng, chá»‰ set endFlag
            if getTimeTrialPoints() > startPoints or getTotalRuns() > startRuns then
                warn("âœ… Äiá»ƒm hoáº·c TotalRuns tÄƒng â†’ ÄÃ¡nh dáº¥u endFlag")
                endFlag = true
                return
            end

            task.wait(1)
        end
    end)
end

-- ğŸ” Teleport farm breakables
local function teleportFarmLoop(startPoints, startRuns)
	while true do
		if lagFlag or endFlag or _G.STOP_TIME_TRIAL then
			warn("âš ï¸ Dá»«ng teleportFarmLoop")
			return
		end

		-- ğŸ” Kiá»ƒm tra nhÃ¢n váº­t Ä‘Ã£ há»“i sinh vÃ  cÃ³ HRP chÆ°a
		local hrp = getHumanoidRootPart()
		if not hrp then
			warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y HumanoidRootPart â†’ Ä‘á»£i há»“i sinh...")
			task.wait(3)
			continue
		end

		local names = {}
		for _, c in ipairs(workspace.__THINGS.Breakables:GetChildren()) do
			if c:IsA("Model") and tonumber(c.Name) then
				table.insert(names, c.Name)
			end
		end

		if #names > 0 then
			for _, n in ipairs(names) do
				if lagFlag or endFlag or _G.STOP_TIME_TRIAL then return end
				local b = workspace.__THINGS.Breakables:FindFirstChild(n)
				if b then
					local p = b:FindFirstChildWhichIsA("BasePart")
					if p then
						teleportTo(p)
						while workspace.__THINGS.Breakables:FindFirstChild(n) do
							if lagFlag or endFlag or _G.STOP_TIME_TRIAL then return end
							task.wait(0.1)
						end
					end
				end
			end
		else
			warn("â³ KhÃ´ng cÃ³ rÆ°Æ¡ng, chá» 20s...")
			local found = false
			for i = 1, 200 do
				if lagFlag or endFlag or _G.STOP_TIME_TRIAL then return end
				task.wait(0.1)
				for _, c in ipairs(workspace.__THINGS.Breakables:GetChildren()) do
					if c:IsA("Model") and tonumber(c.Name) then
						found = true
						break
					end
				end
				if found then break end
			end
			if not found then
				warn("âŒ Háº¿t rÆ°Æ¡ng â†’ káº¿t thÃºc lÆ°á»£t")
				endFlag = true
				return
			end
		end

		task.wait(0.1)
	end
end

-- ğŸ§¹ Cleanup toÃ n bá»™ threads
local function cleanupAllThreads()
	warn("ğŸ§¹ Cleanup toÃ n bá»™ thread & tráº¡ng thÃ¡i")
	if lagMonitorThread then pcall(task.cancel, lagMonitorThread) lagMonitorThread = nil end
	if increaseMonitorThread then pcall(task.cancel, increaseMonitorThread) increaseMonitorThread = nil end
	if monitor12minThread then pcall(task.cancel, monitor12minThread) monitor12minThread = nil end
	lagFlag = false
	endFlag = false
	_G.STOP_TIME_TRIAL = false
	_G.VAR_TIME_TRIAL = nil
end

-- ğŸ Äá»•i quÃ 
local function claimReward()
    warn("ğŸ Báº¯t Ä‘áº§u Ä‘á»•i quÃ ...")

    -- ğŸ“Š Láº¥y Ä‘iá»ƒm Time Trial
    local points = getTimeTrialPoints()

    -- ğŸ“† Giá» Viá»‡t Nam (UTC+7)
    local now = os.date("!*t", os.time(os.date("!*t")) + 7 * 3600)
    local currentDay = now.wday
    local currentHour = now.hour

    -- Náº¿u Thá»© 7 trÆ°á»›c 23h thÃ¬ Ä‘á»•i háº¿t, ngÆ°á»£c láº¡i chá»‰ Ä‘á»•i há»™p 3
    local isSaturdayFull = (currentDay == 7) and (currentHour < 23)

    -- TÃ­nh sá»‘ lÆ°á»£ng tá»«ng loáº¡i há»™p
    local chest3, chest2, chest1 = 0, 0, 0
    if isSaturdayFull then
        warn("ğŸ“† HÃ´m nay lÃ  Thá»© 7 (giá» VN) vÃ  chÆ°a tá»›i 23h â†’ Äá»•i háº¿t toÃ n bá»™ Ä‘iá»ƒm.")
        chest3 = math.floor(points / 5000)
        points = points - chest3 * 5000
        chest2 = math.floor(points / 3000)
        points = points - chest2 * 3000
        chest1 = math.floor(points / 1000)
    else
        warn("ğŸ“† Chá»‰ Ä‘á»•i há»™p 3 (Thá»© 7 sau 23h hoáº·c khÃ´ng pháº£i Thá»© 7 - giá» VN).")
        chest3 = math.floor(points / 5000)
    end

    warn("ğŸ§¾ Sá»‘ láº§n Ä‘á»•i quÃ  sáº½ thá»±c hiá»‡n:")
    warn("ğŸ“¦ Há»™p 3 (5000): " .. chest3)
    warn("ğŸ“¦ Há»™p 2 (3000): " .. chest2)
    warn("ğŸ“¦ Há»™p 1 (1000): " .. chest1)

    local totalChests = chest3 + chest2 + chest1
    if totalChests == 0 then
        warn("âš ï¸ KhÃ´ng cÃ³ pháº§n thÆ°á»Ÿng nÃ o Ä‘á»§ Ä‘iá»ƒm Ä‘á»ƒ Ä‘á»•i.")
        return
    end

    local function openChest(chestType)
        local args = { [1] = chestType }
        return ReplicatedStorage.Network.TimeTrials_OpenChest:InvokeServer(unpack(args))
    end

    local function isAtExactRewardPosition()
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return false end
        local target = Vector3.new(-14221, 17.39, 2210)
        return (hrp.Position - target).Magnitude <= 2
    end

    local function claimMultiple(count, chestType)
        for i = 1, count do
            warn("ğŸ” Äang thá»±c hiá»‡n Ä‘á»•i há»™p " .. chestType .. " - láº§n " .. i)
            local success, err = pcall(function()
                openChest(chestType)
            end)
            if success then
                warn("âœ… Äá»•i thÃ nh cÃ´ng há»™p " .. chestType .. " - láº§n " .. i)
            else
                warn("âŒ Lá»—i khi Ä‘á»•i há»™p " .. chestType .. ": " .. tostring(err))
            end

            task.wait(5)
            if not isAtExactRewardPosition() then
                warn("âš ï¸ Sai vá»‹ trÃ­ sau khi Ä‘á»•i há»™p " .. chestType .. " â†’ teleport láº¡i.")
                teleportToRewardLocation()
                task.wait(9)
                if not isAtExactRewardPosition() then
                    warn("â›” Váº«n sai vá»‹ trÃ­, bá» qua kiá»ƒm tra láº§n nÃ y.")
                else
                    warn("âœ… ÄÃ£ trá»Ÿ láº¡i Ä‘Ãºng vá»‹ trÃ­ Ä‘á»•i.")
                end
            end
        end
    end

    local retry = 0
    while retry < 3 do
        retry += 1
        warn("ğŸš¶â€â™‚ï¸ Teleport tá»›i vá»‹ trÃ­ Ä‘á»•i quÃ  (láº§n " .. retry .. ")...")
        teleportToRewardLocation()
        task.wait(9)
        if isAtExactRewardPosition() then
            warn("âœ… Vá»‹ trÃ­ chÃ­nh xÃ¡c â†’ báº¯t Ä‘áº§u Ä‘á»•i quÃ .")
            break
        else
            warn("âŒ Vá»‹ trÃ­ sai â†’ thá»­ láº¡i.")
        end
    end

    if not isAtExactRewardPosition() then
        warn("â›” KhÃ´ng thá»ƒ Ä‘áº¿n Ä‘Ãºng vá»‹ trÃ­ sau 3 láº§n thá»­ â†’ bá» qua Ä‘á»•i quÃ .")
        return
    end

    claimMultiple(chest3, 3)
    claimMultiple(chest2, 2)
    claimMultiple(chest1, 1)

    task.wait(9)
    teleportToLocation()
end

-- ğŸ”„ Auto-claim song song, cháº¡y má»—i 15 phÃºt
local function startAutoClaim()
    task.spawn(function()
        while true do
            task.wait(15 * 60)

            local pts = getTimeTrialPoints()

            -- Giá» VN
            local d = os.date("!*t", os.time(os.date("!*t")) + 7 * 3600)
            local can = (d.wday == 7 and d.hour < 23 and pts >= 1000)
                    or (d.wday ~= 7 and pts >= 5000)

            if can then
                warn("ğŸ”” Auto-claim: Ä‘á»§ Ä‘iá»u kiá»‡n (giá» VN) â†’ cháº¡y claimReward().")
                claimReward()
            else
                warn("â„¹ï¸ Auto-claim: chÆ°a Ä‘á»§ Ä‘iá»u kiá»‡n (giá» VN) (Points="..pts..").")
            end
        end
    end)
end

-- âœ… VÃ’NG Láº¶P CHÃNH
task.spawn(function()
	waitUntilReachMaxZone(true)
	startMonitor12Min()

	while true do
		while getRunsUsed() < 10 do
			local used = getRunsUsed()
			lagFlag = false
			endFlag = false

			if used > 0 then
				warn("â¸ï¸ Nghá»‰ 30s trÆ°á»›c lÆ°á»£t tiáº¿p theo...")
				task.wait(30)
			end

			local startPoints = getTimeTrialPoints()
			local startRuns = getTotalRuns()

			warn("ğŸ” Báº¯t Ä‘áº§u lÆ°á»£t: " .. tostring(used))
			teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
			task.wait(5)

			local retry = 0
			while not workspace.__THINGS.__INSTANCE_CONTAINER.Active:FindFirstChild("TimeTrial") and retry < 3 do
				retry += 1
				warn("âŒ VÃ o tháº¥t báº¡i, thá»­ láº¡i...")
				teleportTo(workspace.__THINGS.Instances.TimeTrial.Teleports.Enter)
				task.wait(5)
			end

			if not workspace.__THINGS.__INSTANCE_CONTAINER.Active:FindFirstChild("TimeTrial") then
				warn("â›” KhÃ´ng thá»ƒ vÃ o Time Trial.")
				cleanupAllThreads()
				return
			end

			startLagMonitor()
			startIncreaseMonitor(startPoints, startRuns)
			teleportFarmLoop(startPoints, startRuns)

			-- âœ… Náº¿u káº¿t thÃºc lÆ°á»£t (do háº¿t rÆ°Æ¡ng), thoÃ¡t khá»i trial
			if endFlag then
				warn("ğŸšª Káº¿t thÃºc lÆ°á»£t â†’ teleport out")
				safeTeleportOut()
			end

			task.wait(5)

			if lagMonitorThread then pcall(task.cancel, lagMonitorThread) lagMonitorThread = nil end
			if increaseMonitorThread then pcall(task.cancel, increaseMonitorThread) increaseMonitorThread = nil end
		end

		warn("ğŸ‰ HoÃ n táº¥t 10/10 lÆ°á»£t Time Trial.")
		claimReward()
		task.wait(60)
		_G.Time_Trial_Done = true
		_G.Time_Trial_End = true
		cleanupAllThreads()
		
        	-- **Chá»‰ báº¯t Ä‘áº§u auto-claim sau khi Ä‘Ã£ hoÃ n táº¥t 10 lÆ°á»£t**
       		--warn("ğŸ”„ Khá»Ÿi Ä‘á»™ng Auto-Claim sau 10/10 lÆ°á»£t.")
		--task.wait(68)
		--startAutoClaim()

       		warn("ğŸ”„ Khá»Ÿi Ä‘á»™ng Combo Event sau 10/10 lÆ°á»£t.")
		spawn(function()
		--_G.VAR_STOP_BLOCK_PARTY = false
		--_G.VAR_START_BLOCK_PARTY = true
		--loadstring(game:HttpGet("https://raw.githubusercontent.com/dracular111/03/main/Event-Block-Party-3"))()
		--loadstring(game:HttpGet("https://raw.githubusercontent.com/dracular111/03/main/Event-Halloween-Lite"))()
		end)

		warn("â³ Theo dÃµi reset DailyRuns...")
		while getRunsUsed() >= 10 do task.wait(60) end

		warn("ğŸ” DailyRuns reset â†’ tiáº¿p tá»¥c farm.")
		if monitor12minThread then pcall(task.cancel, monitor12minThread) monitor12minThread = nil end
		--_G.VAR_STOP_BLOCK_PARTY = true
		--_G.VAR_START_BLOCK_PARTY = false
		task.wait(5)
		--game.Players.LocalPlayer:Kick("Heo Reset 23H")
		task.wait(5)
		startMonitor12Min()
	end
end)
